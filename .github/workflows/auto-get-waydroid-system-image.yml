name: Auto Get Waydroid Image
run-name: ${{ github.actor }} Auto Get Waydroid Image 🚀
on:
#  schedule:
  push:
  workflow_dispatch:
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - name: Get
        run: |
          VERSION=1.0.0-`date +"%Y%m%d%H%M%S%N"`
          # 配置环境
          echo 配置环境
          sudo apt update
          sudo apt install aria2 curl qemu-utils qemu-system gparted -y
          echo 下载所需安装包
          cd /tmp
          aria2c -x 16 -s 16 https://jihulab.com/gfdgd-xi/waydroid-image/-/raw/main/houdini-install.tar.gz
          tar -xvf houdini-install.tar.gz
          #curl https://repo.waydro.id | sudo bash
          #sudo apt install waydroid -y
          #sudo waydroid init -s GAPPS -f
          
          urlSystem=https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_x86_64/lineage-18.1-20230729-GAPPS-waydroid_x86_64-system.zip/download
          urlVendor=https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_x86_64/lineage-18.1-20230729-MAINLINE-waydroid_x86_64-vendor.zip/download
          aria2c -x 16 -s 16 $urlSystem
          aria2c -x 16 -s 16 $urlVendor
          uSystem=`dirname $urlSystem`
          uVendor=`dirname $urlVendor`
          unzip `basename $uSystem`
          unzip `basename $uVendor`
          # 扩容 img
          qemu-img resize system.img +1G
          sudo modprobe nbd max_ports=8 
          sudo qemu-nbd system.img --connect=/dev/nbd0 | true
          df -H /tmp
          sudo resize2fs -p /dev/nbd0 
          echo 挂载
          sudo mkdir /tmp/mount -p
          sudo mount /dev/nbd0 /tmp/mount
          sudo mkdir -p /tmp/mount/bin | true
          sudo mkdir -p /tmp/mount/etc | true
          sudo mkdir -p /tmp/mount/etc/init | true
          sudo mkdir -p /tmp/mount/lib | true
          sudo mkdir -p /tmp/mount/lib64 | true
          sudo cp /tmp/houdini-install/overlay/system/* /tmp/mount/system -rv | true
          #sudo cp /tmp/houdini-install/overlay/system/etc /tmp/mount/system -rv | true
          sudo cp /tmp/houdini-install/overlay/system/* /tmp/mount/ -rv | true
          #sudo cp /tmp/houdini-install/overlay/system/lib64 /tmp/mount/ -rv | true
          
          sudo umount /tmp/mount | true
          sudo qemu-nbd -d /dev/nbd0 | true
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/share/waydroid-extra
          cp system.img deb/usr/share/waydroid-extra
          cp vendor.img deb/usr/share/waydroid-extra

          cat > deb/DEBIAN/control <<EOF
          Package: waydroid-android-image-gapps
          Version: $VERSION
          Maintainer: gfdgd xi <3025613752@qq.com>
          Homepage: https://github.com/gfdgd-xi/waydroid-runner
          Architecture: amd64
          Severity: serious
          Certainty: possible
          Check: binaries
          Type: binary, udeb
          Priority: optional
          Depends: 
          Section: utils
          Installed-Size: 0
          Description: Waydroid Android 镜像
          EOF
          cat > deb/DEBIAN/postinst <<EOF
          Package: waydroid-android-image-gapps
          #!/bin/bash
          systemctl restart waydroid-container.service | true
          EOF
          cat > deb/DEBIAN/postrm <<EOF
          Package: waydroid-android-image-gapps
          #!/bin/bash
          systemctl restart waydroid-container.service | true
          EOF
          chmod 0775 -Rv deb/DEBIAN
          dpkg-deb -Z xz -z 4 -b deb waydroid-android-image-gapps.deb
          #mv waydroid-android-image-gapps.deb /tmp
          
      - name: upload result(system.img)
        uses: actions/upload-artifact@v1
        with:
          name: system.img
          path: /tmp/system.img
      
      - name: upload result(waydroid-android-image-gapps.deb)
        uses: actions/upload-artifact@v1
        with:
          name: waydroid-android-image-gapps.deb
          path: /tmp/waydroid-android-image-gapps.deb
      #- name: upload result(vendor.img)
       # uses: actions/upload-artifact@v1
       # with:
        #  name: vendor.img
         # path: /usr/share/waydroid-extra/images/vendor.img
  

      
    